FROM node:20-alpine AS builder
WORKDIR /app
RUN corepack enable pnpm

# Build argument for API URL
ARG VITE_API_URL=http://localhost:3000

COPY pnpm-workspace.yaml package.json pnpm-lock.yaml ./
COPY packages/shared/package.json ./packages/shared/
COPY packages/ui/package.json ./packages/ui/

RUN pnpm install --frozen-lockfile

COPY packages/shared ./packages/shared
COPY packages/ui ./packages/ui

RUN pnpm --filter @agentic/shared build
# Set VITE_API_URL as environment variable during build
ENV VITE_API_URL=${VITE_API_URL}
RUN pnpm --filter @agentic/ui build

FROM nginx:alpine
COPY --from=builder /app/packages/ui/dist /usr/share/nginx/html
COPY packages/ui/nginx.conf /etc/nginx/conf.d/default.conf
EXPOSE 80
